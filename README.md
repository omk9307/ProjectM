ProjectM - 통합 기술 상세 설명서 (v10.0.2 - 편집기 UX 및 안정성 강화 버전)
이 문서는 ProjectM 애플리케이션의 아키텍처, 주요 기능 모듈, 그리고 각 클래스의 역할 및 최근 업데이트 내역을 상세하게 설명합니다.
전체 시스템 아키텍처
이 애플리케이션은 모듈형 탭 기반 아키텍처를 채택하고 있습니다.
메인 셸 (main.py): QTabWidget을 사용하여 각 기능 모듈(Learning.py, map.py 등)을 동적으로 로드하는 껍데기(Shell) 역할을 합니다. 이를 통해 각 기능 탭은 독립적으로 개발 및 수정될 수 있으며, 한 탭에서 오류가 발생하더라도 다른 탭에 영향을 주지 않습니다.
기능 모듈 (탭): 각 .py 파일은 하나의 탭에 해당하는 완전한 기능을 구현합니다. 모든 탭은 QWidget을 상속받은 메인 클래스(예: LearningTab, MapTab)를 포함하며, 이 클래스가 해당 탭의 UI와 로직을 총괄합니다.
UI와 로직의 분리: 복잡한 탭(LearningTab)의 경우, UI를 담당하는 메인 클래스와 데이터 처리를 담당하는 백엔드 클래스(DataManager)를 분리하여 코드의 가독성과 유지보수성을 높였습니다.
비동기 처리 (QThread): 모델 훈련, 실시간 객체 탐지, 미니맵 분석 등 시간이 많이 소요되는 작업은 모두 별도의 QThread에서 실행됩니다. 이는 GUI의 "응답 없음" 상태를 방지하고 사용자 경험을 향상시키는 핵심적인 설계 원칙입니다. 스레드는 pyqtSignal을 사용하여 작업 진행 상황, 결과, 에러 등을 메인 GUI 스레드로 안전하게 전달합니다.
리소스 관리: main.py의 closeEvent는 프로그램 종료 시 각 탭에 정의된 cleanup_on_close 메서드를 호출하여, 실행 중인 모든 스레드를 안전하게 종료하고 설정을 저장하는 등 리소스를 정리하는 역할을 수행합니다.
향후 계획: map.py의 내비게이션 알고리즘을 기반으로, 라즈베리파이를 COM 포트를 통해 키보드처럼 연동할 예정입니다. PC에서는 이동 명령(조작키)를 생성하여 라즈베리파이로 전송하고, 라즈베리파이가 PC에 키 입력을 보내 캐릭터를 조작하도록 구현하여 탐지 위험을 감소시킬 것입니다.
Learning.py - 데이터 관리 및 AI 훈련/탐지 모듈 (v1.4 업데이트 반영)
데이터셋 구축, YOLOv8 모델 훈련, 실시간 객체 탐지 기능을 통합 제공하는 애플리케이션의 핵심 모듈입니다. 사용자는 이 탭을 통해 이미지 캡처부터 라벨링, 훈련, 실시간 테스트까지 AI 모델 개발의 전체 파이프라인을 GUI 환경에서 수행할 수 있습니다.
YOLOv8: Ultralytics의 YOLOv8 모델을 사용하여 객체 분할(Segmentation) 모델을 훈련하고 추론합니다.
Segment Anything (SAM): Meta AI의 SAM 모델을 'AI 어시스트' 기능으로 활용하여, 사용자가 몇 번의 클릭만으로 객체의 마스크를 손쉽게 생성할 수 있도록 지원합니다.
데이터 중심 워크플로우: workspace/ 폴더를 중심으로 모든 데이터(이미지, 라벨, 모델, 설정)를 체계적으로 관리합니다.
[v1.3 신규] 하드 네거티브 마이닝 지원: 모델이 자주 오인하는 객체(예: 몬스터처럼 보이는 지형)를 '방해 요소'로 지정하여, 잘라낸 이미지 형태로 데이터셋에 추가할 수 있습니다. 이는 라벨 없는 이미지로 학습되어 모델의 오탐지(False Positive)를 줄이는 데 크게 기여합니다.
[v1.4 신규] 사용자 편의성 강화: 마지막으로 사용한 탐지 모델을 기억하여, 프로그램 재시작 시 자동으로 불러옵니다.
LearningTab(QWidget): '학습' 탭의 모든 UI와 비즈니스 로직을 총괄하는 메인 클래스.
역할: 3단 레이아웃(클래스 목록, 이미지 목록, 훈련/탐지)을 구성하고, 모든 버튼과 위젯의 시그널-슬롯 연결을 관리합니다. [v1.3] 클래스 목록에 '학습 방해 요소 (네거티브)'라는 고정 카테고리를 추가하여, 사용자가 오탐 방지를 위한 네거티브 샘플을 직관적으로 관리할 수 있도록 UI를 확장했습니다.
주요 상호작용:
사용자 입력(버튼 클릭 등)을 받아 DataManager에 데이터 처리를 요청합니다.
훈련, 탐지 등 무거운 작업을 TrainingThread, DetectionThread 등 별도 스레드로 위임합니다.
PolygonAnnotationEditor, SAMAnnotationEditor 같은 편집 다이얼로그를 생성하고, 반환된 결과에 따라 데이터를 처리합니다. [v1.3] 특히, 편집기의 '방해 요소로 저장' 버튼 클릭 시, 지정된 영역을 이미지에서 잘라내어 DataManager를 통해 네거티브 샘플로 저장하는 새로운 로직을 수행합니다. 또한, 기존 방해 요소를 편집하여 라벨을 추가하면 일반 클래스로 '승격'시키는 기능도 처리합니다.
SAMManager를 통해 AI 어시스트 모델의 로딩을 관리합니다.
[v1.4] 프로그램 시작 시 DataManager로부터 마지막 사용 모델 설정을 불러와 UI에 적용하고, 탐지 시작 시 현재 선택된 모델을 설정에 저장하는 역할을 수행합니다.
DataManager: 파일 시스템과의 모든 상호작용을 담당하는 백엔드 클래스.
역할: workspace/ 폴더 내의 모든 경로를 관리하며, 클래스, 이미지, 라벨, 모델, 프리셋, [v1.4] 그리고 애플리케이션 설정에 대한 CRUD(생성, 읽기, 갱신, 삭제) 로직을 캡슐화합니다.
주요 메서드:
get_manifest() / save_manifest(): 클래스 구조와 이미지 목록을 담은 manifest.json을 관리합니다. [v1.3] 이 manifest 파일에 네거티브 샘플 목록을 저장하는 "학습 방해 요소 (네거티브)" 키를 추가로 관리합니다.
rename_class(): 클래스 이름 변경 시, manifest.json 뿐만 아니라 모든 .txt 라벨 파일의 클래스 인덱스까지 자동으로 업데이트하여 데이터 정합성을 유지합니다.
rebuild_manifest_from_labels(): manifest.json이 손상되었을 때, 모든 라벨 파일을 스캔하여 데이터 목록을 복구하는 강력한 기능을 제공합니다. [v1.3] 이 과정에서 내용이 비어있는 라벨 파일을 감지하여 '방해 요소'로 자동 분류합니다.
create_yaml_file(): 훈련 시작 전, 현재 클래스 목록을 기반으로 YOLO 훈련에 필요한 data.yaml 파일을 동적으로 생성합니다.
[v1.3 신규] add_distractor(cropped_image_data): 잘라낸 이미지 데이터를 받아 고유 파일명으로 저장하고, 비어있는 라벨 파일을 생성한 뒤, manifest.json에 등록하는 역할을 전담합니다.
[v1.4 신규] load_settings() / save_settings(data): workspace/config/settings.json 파일을 통해 '마지막 사용 모델'과 같은 사용자 설정을 불러오고 저장하는 범용 메서드입니다.
TrainingThread(QThread): YOLOv8 모델 훈련을 백그라운드에서 수행.
역할: model.train()을 호출하여 훈련을 실행하고, progress 시그널로 로그를, finished 시그널로 결과를 GUI에 전달합니다.
ExportThread(QThread): 훈련된 .pt 모델을 TensorRT(.engine) 형식으로 최적화.
역할: 모델 최적화 작업을 백그라운드에서 처리합니다.
DetectionThread(QThread): 실시간 객체 탐지를 수행.
역할: 지정된 화면 영역을 mss로 계속 캡처하고, YOLO 모델로 추론한 뒤, 결과가 그려진 프레임을 frame_ready 시그널로 GUI에 전송합니다. 캐릭터와 몬스터의 신뢰도를 분리 적용하고, 캐릭터는 가장 신뢰도 높은 하나만 탐지하는 로직을 포함합니다.
SAMManager(QObject): SAM 모델의 다운로드 및 로딩을 관리.
역할: LearningTab의 init_sam에서 생성되어 별도 스레드로 이동됩니다. 모델 파일이 없을 경우 자동으로 다운로드하고, GPU를 사용하여 모델을 메모리에 로드합니다. 로딩이 완료되면 model_ready 시그널을 통해 SamPredictor 객체를 LearningTab에 전달합니다.
PolygonAnnotationEditor(QDialog) / SAMAnnotationEditor(QDialog): 각각 수동, AI 어시스트 라벨링을 위한 다이얼로그 창.
역할: 내부에 전용 캔버스(CanvasLabel 또는 SAMCanvasLabel)를 포함하며, 확대/축소, 클래스 선택, 단축키(C, D, Z, R) 처리 등 편집에 필요한 모든 UI와 로직을 제공합니다. [v1.3] 기존의 '저장', '취소' 버튼 외에 '방해 요소로 저장' 버튼이 추가되었습니다. 이 버튼은 다이얼로그에 특수한 결과 코드(DistractorSaved)를 반환하여, LearningTab이 일반 저장과 구분하여 처리하도록 합니다.
주요 상호작용: LearningTab의 data_manager로부터 전체 클래스 목록을 받아와 선택 UI를 구성하고, 버튼 클릭 결과에 따라 편집된 다각형 데이터를 반환합니다.
BaseCanvasLabel(QLabel): 두 캔버스의 공통 기능을 정의하는 부모 클래스.
역할: 줌/패닝, 기존 다각형 그리기, 마우스 오버 시 하이라이트, 다각형 삭제 등 공통 로직을 처리하여 코드 중복을 방지합니다.
CanvasLabel(BaseCanvasLabel): 수동 편집용 캔버스.
역할: 현재 사용자가 그리고 있는 다각형을 추가로 그리는 로직을 포함.
SAMCanvasLabel(BaseCanvasLabel): AI 편집용 캔버스.
역할: SAM이 예측한 마스크와 사용자의 입력(긍정/부정 클릭)을 시각화합니다.
ClassTreeWidget(QTreeWidget): 클래스 목록을 위한 커스텀 위젯.
역할: 클래스-카테고리 간 드래그앤드롭을 지원하며, 계층 구조 규칙(예: 클래스를 최상위로 이동 불가)을 강제합니다. 드롭 완료 시 drop_completed 시그널을 발생시켜 manifest.json을 업데이트하도록 합니다.
ScreenSnipper, DetectionPopup, EditModeDialog, MultiCaptureDialog: 각각 화면 영역 지정, 탐지 뷰 팝업, 편집 모드 선택, 다중 캡처 선택을 위한 유틸리티 다이얼로그.
map.py - 전체 미니맵 편집 및 내비게이션 시스템
[v10.0.2 이후 추가 및 변경된 내용]
map.py - 전체 미니맵 편집 및 지능형 내비게이션 시스템 (v11.4.5 기준)
v9.0.0에서 도입된 '카메라 뷰' 시스템을 기반으로, 지능형 내비게이션과 정교한 플레이어 상태 판정을 위한 핵심 기능들이 대거 추가 및 개선되었습니다. 특히 v11.0.0에서는 실시간 탐지 파이프라인을 '캡처-탐지 분리' 아키텍처로 전면 개편하여 성능을 극대화했습니다.
캡처-탐지 스레드 분리:
기존: AnchorDetectionThread가 화면 캡처와 탐지를 모두 수행하여 병목 현상 발생.
변경: MinimapCaptureThread가 지정된 FPS로 화면 캡처만 전담하고, AnchorDetectionThread는 캡처된 프레임을 받아 탐지만 수행하도록 역할을 완벽히 분리했습니다. 이를 통해 캡처는 지연 없이 이루어지고, 무거운 탐지 연산이 캡처 주기에 영향을 주지 않아 전체 시스템의 지연 시간(latency)을 대폭 개선했습니다.
연산량 최적화: AnchorDetectionThread는 탐지 시 프레임과 템플릿을 **다운스케일(downscale)**하고, 이전에 탐지된 위치 주변을 먼저 탐색하는 ROI 우선 검색을 적용하여 cv2.matchTemplate 연산량을 크게 줄였습니다.
책임 재분배: 플레이어 아이콘(노란색, 빨간색) 탐지 로직은 AnchorDetectionThread에서 MapTab으로 이동되었습니다. 이로써 AnchorDetectionThread는 핵심 지형 탐지에만 집중하고, MapTab이 모든 정보를 종합하여 최종 판단을 내리는 명확한 구조가 되었습니다.
지능형 내비게이션 엔진 (v10.2 ~ v10.7):
비용 기반 경로 탐색: 단순 거리 계산을 넘어, 걷기, 오르기, 내리기, 점프 등 모든 이동 수단의 비용을 종합적으로 고려하여 최적의 경로를 동적으로 탐색합니다. _calculate_total_cost 메서드가 "현재위치→중간목표→최종목표"의 총 비용을 계산하는 핵심 역할을 합니다.
동적 중간 목표 설정: 최종 목표가 다른 층에 있을 경우, 먼저 도달해야 할 사다리, 점프 지점, 낭떠러지 등을 중간 목표로 자동 설정하고 NavigatorDisplay에 "사다리로 이동"과 같이 명확한 행동 지침을 안내합니다.
플레이어 상태 머신 (v10.8 ~ v11.4):
정교한 상태 판정: 플레이어의 실시간 좌표, 속도, 마지막 지형과의 상대 높이(y_above_terrain) 등을 종합하여 idle, on_terrain, climbing, jumping, falling 5가지 상태를 우선순위 기반으로 판정합니다.
안정적인 상태 전이: in_jump 플래그, 상태 변경 지연(프레임 카운트), 상태 변경 직후의 불응기(last_state_change_time) 등 다양한 메커니즘을 통해, 점프 중 falling으로 바뀌거나 climbing/falling이 빠르게 반복되는 등의 상태 깜빡임(flickering) 문제를 해결하고 안정성을 확보했습니다.
사용자 설정 지원: 상태 판정에 사용되는 모든 임계값(예: JUMP_Y_MIN_THRESHOLD)은 StateConfigDialog를 통해 사용자가 실시간으로 조정하고 프로필에 저장할 수 있습니다.
MapTab(QWidget): '맵' 탭의 모든 UI와 로직을 총괄하는 중앙 컨트롤 타워.
__init__(self): UI 생성, 프로필 로드 등 초기화 작업을 수행합니다. v11.3.7부터 상태 판정 설정 변수(self.cfg_...)는 여기서 None으로 선언만 하고, 실제 값 할당은 load_profile_data로 위임하여 데이터 흐름을 명확히 했습니다.
_update_player_state_and_navigation(self, final_player_pos): 내비게이션 시스템의 두뇌. 매 프레임마다 플레이어의 전역 좌표를 입력받아, 위에서 설명한 플레이어 상태 머신을 구동하고, 비용 기반 경로 탐색 엔진을 통해 다음 행동을 결정한 뒤, 그 결과를 NavigatorDisplay에 업데이트합니다.
toggle_anchor_detection(self, checked): 탐지 시작/중단 버튼과 연결된 메서드. v11.0.0 업데이트로 인해, 이제 MinimapCaptureThread와 AnchorDetectionThread 두 개의 스레드를 생성하고 관리하는 역할을 합니다.
on_detection_ready(self, frame_bgr, found_features, ...): AnchorDetectionThread로부터 핵심 지형 탐지 결과를 받는 슬롯. v11.0.0부터 이 메서드가 직접 frame_bgr에서 플레이어 아이콘을 탐지하고, RANSAC 알고리즘을 통해 플레이어의 최종 전역 좌표를 계산하는 핵심적인 역할을 수행합니다.
_open_state_config_dialog(self): [v11.3.0 신규] '판정 설정' 버튼과 연결되어, StateConfigDialog 팝업을 열고 사용자가 변경한 설정값을 저장하는 역할을 합니다.
_build_line_floor_map(self): [v11.4.5 신규] 지형선 ID와 층 정보를 미리 계산하여 self.line_id_to_floor_map 딕셔너리에 캐싱하는 헬퍼 메서드. 맵 데이터가 변경될 때만 호출되어 성능을 최적화합니다.
_check_near_ladder(self, ...): [v11.4.5 개선] 플레이어가 사다리 근처에 있는지 판별하는 함수. 캐싱된 line_id_to_floor_map을 사용하여, 현재 플레이어가 있는 층과 연결된 사다리만 필터링하여 검사함으로써 성능과 정확도를 향상시켰습니다.
MinimapCaptureThread(QThread): [v11.0.0 신규]
역할: 화면 캡처 전담 스레드. 오직 mss.grab()을 이용해 지정된 FPS로 미니맵 영역을 캡처하고, threading.Lock을 통해 최신 프레임을 self.latest_frame에 안전하게 저장하는 역할만 수행합니다.
run(self): target_fps에 맞춰 while self.is_running: 루프를 돌며 화면을 캡처하고 time.sleep()으로 주기를 조절합니다.
AnchorDetectionThread(QThread):
역할: [v11.0.0 역할 변경] 핵심 지형 탐지 전담 스레드. 더 이상 화면을 직접 캡처하지 않습니다.
run(self): safe_read_latest_frame 헬퍼 함수를 통해 MinimapCaptureThread로부터 최신 프레임의 복사본을 안전하게 가져옵니다. 가져온 프레임과 미리 처리된 템플릿을 다운스케일하여 cv2.matchTemplate을 수행합니다. ROI 우선 검색을 통해 탐지 속도를 높이고, 성능 저하 시 다운스케일 비율을 자동 조절하는 폴백(fallback) 로직을 포함합니다. 탐지된 핵심 지형 정보와 원본 프레임을 detection_ready 시그널로 MapTab에 전달합니다.
StateConfigDialog(QDialog): [v11.3.0 신규]
역할: 플레이어 상태 판정 및 도착 판정에 사용되는 모든 임계값을 사용자가 직접 조정할 수 있는 팝업 창입니다.
주요 상호작용: MapTab으로부터 현재 설정값을 받아 UI를 초기화하고, 사용자가 '저장' 버튼을 누르면 변경된 값을 반환하여 MapTab이 이를 map_config.json에 저장하도록 합니다. '기본값 복원' 기능도 제공합니다.
FullMinimapEditorDialog(QDialog):
역할: 전체 맵의 모든 물리적 구조(geometry_data)를 시각적으로 생성하고 편집하는 통합 도구.
최신 변경 사항 (v11.2+): LOD(Level of Detail) 기능이 강화되어, 특정 배율 이상으로 확대 시 지형선과 층 이동 오브젝트의 좌표가 텍스트로 표시됩니다. 텍스트와 배경의 스타일(색상, 모양, 크기)이 여러 번의 개선을 통해 가독성이 최적화되었습니다. _create_coord_text_item 헬퍼 메서드를 통해 좌표 텍스트와 배경을 생성하고, populate_scene에서 이들의 위치를 정밀하게 계산하여 배치합니다.
NavigatorDisplay(QWidget):
역할: [v10.3+ 기능 활성화] 실시간 내비게이션 정보를 시각적으로 표시하는 대시보드.
최신 변경 사항: MapTab의 상태 머신이 판정한 플레이어의 현재 상태(예: '점프 중')와 필요 행동(예: '다음 목표로 이동')을 우측 패널에 명확히 표시하여, 시스템의 내부 동작을 사용자가 직관적으로 이해할 수 있도록 합니다.
v9.0.0 대규모 시스템 개편을 기점으로, 기존의 웨이포인트 기반 위치 추정 방식에서 벗어나 전체 맵 데이터를 직접 활용하는 '카메라 뷰' 방식으로 시스템을 전면 개편했습니다. 이를 통해 시스템의 복잡도를 낮추고 정확성과 직관성을 크게 향상시켰습니다.
전체 맵 기반 렌더링: 더 이상 개별 웨이포인트의 미니맵 조각을 사용하지 않습니다. 대신, 프로필 로드 시 _generate_full_map_pixmap을 통해 모든 웨이포인트 배경과 지형/오브젝트 정보를 합성한 단 하나의 거대한 '전체 맵' 이미지를 미리 생성합니다.
탐지 로직 단순화: AnchorDetectionThread의 역할이 대폭 축소되었습니다. 이제 이 스레드는 복잡한 위치 보정이나 경로 안내 없이, 오직 실시간 미니맵 화면에서 '핵심 지형'과 '플레이어'를 탐지하고 그 로컬 좌표를 MapTab에 전달하는 역할만 수행합니다.
카메라 뷰 (Camera View): RealtimeMinimapView라는 새로운 위젯이 실시간 뷰를 전담합니다. 이 위젯은 MapTab으로부터 플레이어의 전역 좌표를 전달받아, 미리 생성된 '전체 맵' 이미지 위에서 해당 좌표를 중심으로 하는 영역을 잘라내어 보여줍니다. 이는 마치 거대한 지도 위를 카메라가 따라다니는 것과 같은 효과를 냅니다.
데이터 동기화 강화 (v9.0.6): 데이터가 변경(추가, 수정, 삭제)될 때마다 save_profile_data 함수가 호출됩니다. 이 함수는 파일 저장 직후, _update_map_data_and_views라는 중앙 관리 함수를 호출하여 전역 좌표계 재계산과 전체 맵 이미지 재생성을 자동으로 수행합니다. 이를 통해 '핵심 지형 관리자', '웨이포인트 편집기', '실시간 뷰' 간의 데이터 불일치 문제를 해결하고 항상 최신 상태를 유지합니다.
CroppingLabel(QLabel): FeatureCropDialog에서 영역을 시각적으로 표시하는 데 사용되는 간단한 QLabel 서브클래스.
역할: FeatureCropDialog의 배경 이미지 위에 사용자가 드래그하는 사각형 영역을 실시간으로 그려줍니다.
최근 변경 사항: FeatureCropDialog가 QGraphicsView 기반으로 변경되면서, 이 클래스는 현재 사용되지 않습니다. (다만 코드 파일에는 여전히 존재합니다.)
FeatureCropDialog(QDialog): 새로운 핵심 지형을 추가할 때, 미니맵 이미지에서 특정 영역을 잘라낼 수 있도록 돕는 다이얼로그.
역할: 캡처된 미니맵 이미지 위에서 사용자가 마우스 드래그로 핵심 지형 영역을 지정하고, 해당 영역의 이미지 데이터를 반환합니다.
주요 상호작용: MapTab에서 호출되며, 선택된 영역의 QRect 객체를 반환합니다.
최근 변경 사항 (v9.0.5):
기존 QLabel 기반에서 QGraphicsView 기반(ZoomableView)으로 전환되어 휠 확대/축소 및 휠 클릭 패닝 기능이 추가되었습니다.
다이얼로그가 화면에 완전히 표시된 후 fitInView를 호출하여 초기 배율이 최적화되었습니다 (이미지가 너무 작게 보이던 문제 해결).
영역 지정 시 커서가 십자(+) 모양으로 고정됩니다.
KeyFeatureManagerDialog(QDialog): 등록된 핵심 지형을 관리(추가, 이름 변경, 삭제)하고, 각 지형이 어떤 웨이포인트에서 사용되고 있는지 보여주는 다이얼로그.
역할: 핵심 지형 데이터(self.key_features)의 CRUD 작업을 수행하고, 관련 웨이포인트와의 연결 상태를 시각화합니다.
주요 상호작용: MapTab의 self.key_features와 self.route_profiles를 참조하여 데이터를 표시하고 수정합니다. parent_map_tab.save_profile_data()를 호출하여 변경사항을 저장합니다.
최근 변경 사항 (v9.0.6):
'전체 웨이포인트 갱신' (on_update_all_clicked) 기능이 MapTab.update_all_waypoints_with_features를 호출하도록 변경되어, 웨이포인트와 핵심 지형 간의 연결 정보 불일치 문제를 해결했습니다.
지형 삭제 시 MapTab의 원본 웨이포인트 데이터에서 해당 지형 링크가 즉시 제거되고 저장됩니다.
AdvancedWaypointCanvas(QLabel): AdvancedWaypointEditorDialog에서 웨이포인트의 목표 지점 및 관련 핵심 지형을 그리는 데 사용되던 캔버스.
역할: 웨이포인트 편집 시 배경 미니맵 이미지 위에 목표 지점(초록색)과 탐지된 핵심 지형(파란색)을 표시하고, 사용자가 새로운 핵심 지형(주황색)을 그리거나 기존 지형을 삭제할 수 있도록 마우스 이벤트를 처리했습니다.
최근 변경 사항: AdvancedWaypointEditorDialog가 QGraphicsView 기반으로 완전히 재구현되면서, 이 클래스는 현재 사용되지 않습니다. (다만 코드 파일에는 여전히 존재합니다.)
AdvancedWaypointEditorDialog(QDialog): 개별 웨이포인트를 상세하게 편집하는 다이얼로그. 목표 지점 및 연결된 핵심 지형을 지정/수정할 수 있습니다.
역할: 특정 웨이포인트의 이름, 미니맵 이미지, 목표 지점, 그리고 웨이포인트와 관련된 핵심 지형(이미 탐지된 것, 새로 추가할 것, 삭제할 것)을 시각적으로 편집할 수 있도록 합니다.
주요 상호작용: MapTab에서 호출되며, 수정된 웨이포인트 데이터와 핵심 지형 변경 정보를 MapTab으로 전달합니다. parent_map_tab.key_features를 참조하여 편집합니다.
최근 변경 사항 (v9.0.5):
기존 QLabel 기반에서 QGraphicsView 기반(ZoomableView)으로 전환되어 휠 확대/축소 및 휠 클릭 패닝 기능이 추가되었습니다.
다이얼로그가 화면에 완전히 표시된 후 fitInView를 호출하여 초기 배율이 최적화되었습니다.
편집 모드(목표 지점, 핵심 지형)에 따라 커서가 십자(+) 모양으로 유지됩니다.
CustomGraphicsView(QGraphicsView): FullMinimapEditorDialog에서 사용되는 커스텀 QGraphicsView.
역할: 전체 맵 편집기에서 확대/축소, 패닝, 마우스 이벤트 전달 기능을 제공합니다.
주요 상호작용: FullMinimapEditorDialog의 on_scene_mouse_press, on_scene_mouse_move 등과 연결되어 지형 그리기/삭제 로직을 수행합니다.
최근 변경 사항: map.py의 CustomGraphicsView 자체에는 v7.8.1 이후 직접적인 변경 사항이 없습니다.
FullMinimapEditorDialog(QDialog): 전체 맵에 지형선(terrain_lines)과 층 이동 오브젝트(transition_objects)를 직접 그리고 편집하는 다이얼로그.
역할: 모든 웨이포인트의 미니맵들을 합성한 전체 맵 위에서, 플레이어가 이동 가능한 지형과 층 이동 오브젝트의 위치 및 형태를 정의합니다.
주요 상호작용: MapTab으로부터 모든 맵 데이터(key_features, route_profiles, geometry_data, global_positions)를 받아 맵을 렌더링하고, 변경된 geometry_data를 MapTab으로 반환하여 저장하도록 합니다. MapTab의 실시간 플레이어 위치(global_pos_updated 시그널)를 받아 Y/X축 고정선 위치를 업데이트합니다.
최근 변경 사항: map.py의 FullMinimapEditorDialog 자체에는 직접적인 변경 사항이 없습니다.
RealtimeMinimapView(QLabel): (신규 클래스, v9.0.0 도입) 전체 맵을 기반으로 플레이어 시점의 '카메라 뷰'를 실시간으로 렌더링하는 커스텀 위젯.
역할: MapTab에서 계산된 플레이어의 전역 좌표를 중심으로 전체 맵의 일부를 잘라내어 표시하고, 그 위에 플레이어, 다른 유저, 핵심 지형, 웨이포인트, 지형선, 오브젝트 등을 동적으로 오버레이하여 보여줍니다. 마우스 휠 줌 및 드래그 패닝을 지원합니다.
주요 상호작용: MapTab으로부터 camera_center, active_features, my_players, other_players 등 렌더링에 필요한 최신 데이터를 update_view_data 메서드를 통해 전달받아 화면을 갱신합니다.
최근 변경 사항 (v9.0.1+):
(v9.0.1) 핵심 지형 렌더링 개선: 감지된 지형은 파란색 실선, 미감지 지형은 흰색 점선 테두리로 표시하며, 내부를 채우지 않도록 변경되었습니다. 핵심 지형 이름은 사각형 중앙에 표시됩니다.
(v9.0.1) 웨이포인트 렌더링 개선: 웨이포인트 이름 대신 경로 순서(숫자)가 사각형 중앙에 표시됩니다.
(v9.0.2) 탐지 정확도 표시: 감지된 핵심 지형 사각형의 바깥쪽 위(수평 중앙)에 실시간 탐지 정확도(소수점 둘째 자리까지, 노란색, 7pt, 일반 폰트)가 표시됩니다.
(v9.0.4) 카메라 자동 추적 제어: MapTab의 '캐릭터 중심' 체크박스 상태에 따라 카메라가 플레이어를 자동 추적할지(self.camera_center_global 업데이트) 아니면 사용자가 드래그한 위치에 머무를지 결정하도록 로직이 변경되었습니다.
AnchorDetectionThread(QThread): 지정된 미니맵 영역을 계속 스캔하여, 등록된 핵심 지형과 플레이어 아이콘의 로컬 좌표를 탐지하고 메인 스레드로 전달하는 역할만 수행하는 스레드.
역할: 스크린샷 캡처, HSV 색상 마스킹을 통한 플레이어 아이콘 탐지, 템플릿 매칭을 통한 핵심 지형 탐지를 백그라운드에서 수행합니다. 탐지된 객체의 id, local_pos, conf 정보를 detection_ready 시그널을 통해 MapTab으로 전달합니다.
최근 변경 사항: map.py의 AnchorDetectionThread 자체에는 직접적인 변경 사항이 없습니다.
MapTab(QWidget): '맵' 탭의 모든 UI와 핵심 로직을 총괄하는 메인 컨트롤러 클래스.
역할: 맵 프로필 로드/저장, 미니맵 영역 설정, 웨이포인트/경로 프로필/핵심 지형 관리, 전체 맵 데이터(지형선, 오브젝트) 편집기 실행, 실시간 탐지 제어 등 맵 시스템 전반을 관리합니다. _calculate_global_positions로 전역 좌표계를 계산하고 _generate_full_map_pixmap으로 전체 맵 이미지를 생성하여 메모리에 보관합니다.
주요 상호작용: AnchorDetectionThread로부터 탐지 결과를 받아 플레이어의 전역 좌표를 계산하고 RealtimeMinimapView에 렌더링을 지시합니다. KeyFeatureManagerDialog, AdvancedWaypointEditorDialog, FullMinimapEditorDialog 등 모든 하위 다이얼로그와 데이터를 주고받으며, save_profile_data를 통해 데이터 무결성을 보장합니다. global_pos_updated 시그널로 FullMinimapEditorDialog에 플레이어 위치를 전달합니다.
최근 변경 사항:
(v9.0.3) global_pos_updated 시그널의 타입이 (float, float)에서 QPointF로 변경되어 X, Y 좌표 전달의 정확성과 안정성이 향상되었습니다.
(v9.0.3) on_detection_ready 메서드에서 플레이어의 Y축 위치 계산 시 player_rect.bottom() 대신 float(player_rect.y() + player_rect.height())를 사용하여 정확한 바닥 좌표를 얻도록 수정되었고, PLAYER_Y_OFFSET 상수를 통해 미세 Y 좌표 보정 기능이 추가되었습니다.
(v9.0.4) initUI에 '실시간 미니맵 뷰' 라벨 옆에 '캐릭터 중심' QCheckBox가 추가되었습니다.
(v9.0.4) on_detection_ready 메서드에서 이 체크박스의 상태에 따라 RealtimeMinimapView의 카메라가 플레이어를 자동 추적할지 여부를 제어하도록 로직이 변경되었습니다.
(v9.0.6) update_all_waypoints_with_features 메서드가 self.route_profiles의 원본 데이터를 직접 수정하도록 변경되어, 핵심 지형과 웨이포인트 간의 연결 정보 동기화 문제(사용처 불일치 등)가 완전히 해결되었습니다.
ZoomableView(QGraphicsView): (v9.0.5 도입) QGraphicsView를 상속받아 휠 확대/축소 및 휠 클릭 패닝 기능을 제공하는 재사용 가능한 뷰 클래스.
역할: FeatureCropDialog와 AdvancedWaypointEditorDialog의 핵심 뷰로 사용되어, 이미지 편집 시 사용자에게 유연한 뷰 제어 기능을 제공합니다. set_drawing_mode 메서드를 통해 커서 모양(십자 또는 손바닥)과 드래그 모드를 전환할 수 있습니다.
주요 상호작용: mousePressEvent, mouseMoveEvent, mouseReleaseEvent를 오버라이딩하여 휠 클릭 이벤트를 처리합니다.
최근 변경 사항: ZoomableView의 도입 자체가 최근 변경 사항의 핵심입니다.
v9.0.0에서 도입된 전체 맵 기반 '카메라 뷰' 시스템을 한 단계 발전시켜, 복층 구조와 지형 점프를 포함하는 지능형 내비게이션 시스템의 기반을 마련했습니다. 또한, RANSAC 알고리즘과 사전 필터링을 도입하여 실시간 위치 추정의 안정성을 대폭 향상시켰습니다.
지능형 내비게이션 기반 구축:
층(Floor) 개념 도입: 모든 지형 데이터(terrain_lines, waypoints 등)에 floor 필드가 추가되어 맵을 수직적으로 구분하고, 층간 이동 경로 계산의 기반을 마련했습니다. QDoubleSpinBox를 통해 소수점 층(예: 1.5층)까지 세밀하게 관리할 수 있습니다.
지형 점프 연결: 물리적으로 떨어져 있지만 점프로 이동 가능한 두 지형의 꼭짓점을 연결하는 '지형 점프 링크(jump_links)' 데이터 구조와 편집 기능이 추가되었습니다.
데이터 구조 확장 및 분리:
map_geometry.json: 이제 맵의 물리적 구조 정보(terrain_lines, transition_objects, waypoints, jump_links)만을 독립적으로 저장하여 데이터의 역할을 명확히 했습니다.
map_config.json: 경로 순서 정보(route_profiles)와 같은 논리적 설정은 여기에 저장됩니다.
경로 분리 (Forward/Backward Path): 각 route_profiles는 forward_path와 backward_path라는 두 개의 리스트에 웨이포인트의 고유 ID(wp-uuid) 순서만을 저장하여, 정방향과 역방향 경로를 독립적으로 관리할 수 있게 되었습니다.
강건한(Robust) 위치 추정:
RANSAC 사전 필터링: 실시간 위치 추정 시, RANSAC 알고리즘에 입력되는 핵심 지형 데이터를 각 지형의 신뢰도(conf)와 임계값(threshold)을 기준으로 사전 필터링합니다. 이를 통해 신뢰도 낮은 지형이 위치 계산을 오염시키는 문제를 근본적으로 해결하여, RealtimeMinimapView의 흔들림 현상을 제거하고 안정성을 크게 향상시켰습니다.
기준 앵커 재설정 안정화: KeyFeatureManagerDialog에서 기준 앵커를 변경할 때, 맵의 모든 절대 좌표(terrain_lines, waypoints 등)를 새로운 원점 기준으로 평행 이동하여 재계산하는 로직을 구현했습니다. 이를 통해 앵커 변경 후에도 좌표계가 일관성을 유지하도록 보장합니다.
NavigatorDisplay(QWidget): (신규) 실시간 내비게이션 정보를 그래픽으로 표시하기 위해 추가된 위젯. 현재는 UI 자리만 차지하고 있으며, 3단계에서 데이터가 연동될 예정입니다.
KeyFeatureManagerDialog(QDialog): 등록된 핵심 지형을 관리하는 다이얼로그.
최신 변경 사항:
기준 앵커 지정 기능 추가: 특정 지형을 맵 좌표계의 원점(0,0)으로 설정하는 기능이 추가되었습니다. 이 작업 시 모든 지오메트리 데이터의 전역 좌표가 자동으로 재계산되어 시스템 안정성이 확보되었습니다.
'전체 웨이포인트 갱신' 버튼이 제거되었습니다.
FullMinimapEditorDialog(QDialog): 전체 맵에 지형 및 내비게이션 요소를 직접 그리고 편집하는 핵심 다이얼로그.
역할: v10.0.0 업데이트의 핵심으로, 기존의 지형선/오브젝트 편집 기능에 더해 웨이포인트 생성, 지형 점프 연결, 층 정보 할당 등 맵 제작에 필요한 모든 기능을 통합 제공합니다.
주요 기능 (v10.0.0 신규/확장):
편집 모드: '기본', '지형 입력', '층 이동 오브젝트'에 더해 '웨이포인트 추가', '지형 점프 연결' 모드가 추가되었습니다.
층 관리: 현재 편집 중인 층을 QDoubleSpinBox로 지정하며, 생성되는 모든 지오메트리(지형, 점프, 웨이포인트)에 해당 층 정보가 자동으로 할당됩니다.
웨이포인트 생성: '웨이포인트 추가' 모드에서 지형선을 클릭하면 해당 위치에 바로 웨이포인트를 생성하고 이름을 지정할 수 있습니다. 생성된 웨이포인트는 부모 지형선의 층 정보를 상속받습니다.
지형 점프 연결: '지형 점프 연결' 모드에서 두 지형선 꼭짓점(vertex)을 순서대로 클릭하여, 물리적으로 떨어져 있지만 점프로 이동 가능한 경로를 생성합니다.
RealtimeMinimapView(QLabel): 전체 맵 기반의 '카메라 뷰'를 실시간으로 렌더링하는 커스텀 위젯.
최신 변경 사항:
paintEvent에서 jump_links를 녹색 점선으로 그리는 로직이 추가되었습니다.
update_view_data를 통해 목표 웨이포인트, 마지막 도착 웨이포인트 ID를 받아 렌더링에 반영할 수 있도록 확장되었습니다
MapTab(QWidget): '맵' 탭의 모든 UI와 핵심 로직을 총괄하는 메인 컨트롤러 클래스.
역할: 맵 프로필 로드/저장, 경로 프로필/핵심 지형 관리, 전체 맵 편집기 실행, 실시간 탐지 제어 등 맵 시스템 전반을 관리합니다.
최신 변경 사항:
UI 개편: 웨이포인트 관리 패널이 정방향/역방향 QTabWidget으로 변경되었고, 실시간 뷰 위에 NavigatorDisplay 위젯이 추가되었습니다. 또한 '탐지 제어' 섹션에 "디버그 뷰 표시" QCheckBox가 추가되어 디버그 창을 동적으로 켜고 끌 수 있게 되었습니다.
데이터 관리: 프로필 로드 시 migrate_data_structures를 통해 구버전 데이터(웨이포인트 리스트 등)를 v10.0.0의 새로운 구조(waypoints 분리, forward/backward_path)로 자동 변환합니다.
위치 추정 로직 강화 (on_detection_ready):
사전 필터링: RANSAC 실행 전, 신뢰도가 threshold 미만인 핵심 지형을 후보군에서 제외하여 위치 추정의 안정성을 확보했습니다.
적응형 EMA 필터: 정상치(inlier)의 수와 평균 신뢰도에 따라 스무딩 강도를 동적으로 조절하여 반응성과 안정성을 모두 개선했습니다.
웨이포인트 경로 관리: FullMinimapEditorDialog에서 생성된 웨이포인트 목록을 불러와, 사용자가 선택한 웨이포인트의 ID를 현재 활성화된 경로(forward_path 또는 backward_path) 리스트에 추가하고 순서를 관리하는 로직이 구현되었습니다.
v10.0.0에서 구축된 내비게이션 시스템의 기반을 안정화하고, 편집기 및 실시간 뷰의 사용자 경험(UX)을 대폭 개선하는 데 중점을 두었습니다.
안정성 강화 및 기능 개선 (v10.0.1):
지형 점프 역할 확장: 지형 점프 연결(jump_link)이 기존의 동일 층 내 이동뿐만 아니라, 높이 차가 적은 다른 층 사이를 이동하는 수단으로도 사용되도록 역할이 확장되었습니다.
직관적인 이름 규칙: 점프 링크의 동적 이름이 [시작층]층_[종료층]층[A/B/C...] 형식으로 자동 부여되어, 연결 관계를 한눈에 파악할 수 있도록 개선되었습니다.
데이터 무결성 및 UI 동기화: 지형 그룹 삭제 시, 해당 지형에 종속된 층 이동 오브젝트와 연결된 점프 링크가 데이터와 UI에서 즉시 함께 삭제되도록 연쇄 삭제 로직을 강화했습니다. 점프 링크를 추가하거나 삭제할 때 발생하던 각종 UI 갱신 지연 문제와 QGraphicsScene::removeItem 관련 크래시를 완전히 해결하여 편집기의 안정성을 확보했습니다.
사용자 경험(UX) 개선 (v10.0.2):
FullMinimapEditorDialog (편집기) 개선 사항:
일관된 탐색: '기본' 모드뿐만 아니라 모든 편집 모드에서 마우스 휠 스크롤 줌과 휠 클릭 패닝이 가능하도록 CustomGraphicsView를 개선했습니다.
편의 기능 추가: '기본' 모드에서 웨이포인트를 좌클릭하여 즉시 이름을 변경하는 기능을 추가하고, 이름 변경 후 원치 않는 드래그가 발생하는 버그를 수정했습니다.
UI 즉시 갱신: 웨이포인트를 추가하거나, 지형의 층 정보를 변경했을 때 관련된 모든 정보(이름, 층 번호)가 편집기와 메인 UI에 즉시 반영되도록 데이터 동기화 로직을 강화했습니다.
스냅 로직 개선: 좁은 간격으로 여러 지형선이 겹쳐 있는 구역에서도 사용자가 의도한 지형선에 웨이포인트가 안정적으로 스냅되도록 로직을 개선했습니다.
가독성 향상: 웨이포인트가 다른 요소에 가려지지 않도록 항상 최상위에 표시(Z-value 조정)하고, 줌 레벨에 따라 이름표(지형, 웨이포인트 등)가 동적으로 사라지거나 나타나도록 LOD(Level of Detail) 적용 대상을 확대했습니다.
RealtimeMinimapView (실시간 뷰) 개선 사항:
경로 안내 명확화: 웨이포인트 경로의 시작점과 끝점을 숫자 대신 **"출발지"**와 **"목적지"**로 표시하여 직관성을 높였습니다.
가독성 향상: 현재 목표 웨이포인트(빨간색 배경)의 텍스트 색상을 흰색으로 고정하고, "도착" 알림 텍스트의 위치를 조정하여 가독성을 개선했습니다.
main.py - 애플리케이션 셸 및 로더
애플리케이션의 진입점(Entry Point)으로, 전체 프로그램의 뼈대를 구성하고 각 기능 모듈을 탭으로 통합하는 역할을 합니다.
MainWindow(QMainWindow): 애플리케이션의 메인 윈도우.
역할: QTabWidget을 중앙 위젯으로 설정하고, load_tabs 메서드를 통해 지정된 모듈들을 순차적으로 로드합니다.
주요 기능:
동적 모듈 로딩: importlib를 사용하여 모듈 이름(문자열)으로 실제 모듈을 임포트합니다. 이 덕분에 설정 파일 변경만으로 새로운 탭을 쉽게 추가하거나 제거할 수 있는 확장성 있는 구조를 가집니다.
오류 처리: try-except 구문을 사용하여 특정 탭 로딩에 실패하더라도 프로그램이 중단되지 않고, 대신 사용자에게 원인을 알려주는 '오류 탭'을 표시합니다.
상태 저장 (QSettings): 프로그램 종료 시 closeEvent에서 현재 창의 위치와 크기를 저장하고, 재시작 시 이를 복원하여 사용자 편의성을 높입니다.
자원 해제: closeEvent에서 각 탭 위젯의 cleanup_on_close 메서드를 순차적으로 호출하여, 모든 백그라운드 스레드가 안전하게 종료되도록 보장합니다.
향후 개발 계획 (변동 가능성 있음): 층간 내비게이션 시스템
현재까지 구축된 '전체 미니맵 편집기'의 지형 데이터를 활용하여, 복층 구조의 맵에서 층간 이동을 포함한 최단 경로를 탐색하는 고차원 내비게이션 시스템을 구현합니다.
목표: 사용자가 맵의 어느 지점이든 목표로 설정하면, 현재 위치에서 목표까지 지형선을 따라 이동하고, 필요한 경우 층 이동 오브젝트(사다리, 포탈)를 사용하여 층을 바꾸는 전체 경로를 생성하고 안내합니다.
핵심 개념:
층 (Floor) 관리: 사용자가 "1층", "2층" 등 층 정보를 생성하고 관리하는 기능.
지형선에 층 정보 할당: 사용자가 편집기에서 특정 지형선을 선택하고, 해당 지형선이 몇 층에 속하는지 지정하는 기능. (기본값은 1층)
층 이동 오브젝트 연결: 사용자가 층 이동 오브젝트(사다리 등)를 선택하고, 이 오브젝트가 어떤 지형선(시작 층)에서 시작하여 어떤 지형선(도착 층)으로 연결되는지 명시적으로 지정하는 기능. 이는 양방향 이동을 기본으로 합니다.
구현 계획:
데이터 구조 확장: map_geometry.json을 수정합니다.
terrain_lines의 각 객체에 "floor": 1 과 같은 층 정보 필드를 추가합니다.
transition_objects의 각 객체에 "start_line_id": "...", "end_line_id": "..." 와 같이 연결된 두 지형선의 ID를 저장하는 필드를 추가합니다.
편집기 UI/UX 추가: FullMinimapEditorDialog에 다음 기능을 추가합니다.
층 관리 패널: 층을 추가/삭제/이름 변경할 수 있는 UI.
지형선 속성 편집: 지형선을 선택하고 드롭다운 메뉴 등을 통해 생성된 층 목록 중 하나를 할당하는 기능.
오브젝트 연결 도구: 층 이동 오브젝트를 선택한 후, 시작 지형선과 도착 지형선을 순서대로 클릭하여 연결 관계를 설정하는 기능.
내비게이션 알고리즘 고도화:
경로 탐색 시, 맵 전체를 하나의 거대한 **그래프(Graph)**로 간주합니다.
노드(Node): 모든 지형선의 각 꼭짓점, 층 이동 오브젝트의 시작/끝점.
엣지(Edge):
같은 지형선 위의 인접한 꼭짓점들을 잇는 선분 (가중치: 거리).
층 이동 오브젝트 자체 (가중치: 이동 시간 또는 거리).
층 이동 오브젝트의 끝점과 연결된 지형선 위의 가장 가까운 점을 잇는 가상의 연결선.
A* (A-Star) 알고리즘 등을 사용하여 이 그래프 상에서 현재 위치에서 목표 지점까지의 최단 경로를 계산합니다. 계산된 경로는 [지형선 이동 -> 오브젝트 이용 -> 다른 지형선 이동] 과 같은 일련의 행동 계획으로 출력됩니다.